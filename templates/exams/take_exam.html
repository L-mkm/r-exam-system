{% extends "base.html" %}

{% block title %}参加考试 - {{ exam.title }}{% endblock %}

{% block content %}
<!-- 添加一个全局可访问的CSRF令牌 -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container mt-4">
    <div class="row">
        <!-- 左侧考试信息和题目导航 -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">考试信息</div>
                <div class="card-body">
                    <h5>{{ exam.title }}</h5>
                    <p class="text-muted">{{ exam.description|default('无描述') }}</p>
                    <p><strong>总分值:</strong> {{ exam.total_score }}</p>
                    <p><strong>开始时间:</strong> {{ exam.start_time.strftime('%Y-%m-%d %H:%M') }}</p>
                    <p><strong>结束时间:</strong> {{ exam.end_time.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">考试倒计时</h5>
                </div>
                <div class="card-body text-center">
                    <!-- 保留原始元素，但隐藏 -->
                    <span id="remaining-time" style="display: none;">{{ remaining_seconds }}</span>
                    <div id="exam-timer" class="alert alert-info">
                        <h3 id="timer-display" class="mb-0">
                            <span id="hours">00</span>:<span id="minutes">00</span>:<span id="seconds">00</span>
                        </h3>
                        <small class="text-muted">剩余时间</small>
                    </div>
                    <div id="exam-timer-warning" class="alert alert-danger" style="display: none;">
                        <strong>注意：</strong> 考试时间即将结束！
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">题目导航</div>
                <div class="card-body">
                    <div class="question-nav">
                        {% for eq in exam_questions %}
                        <button
                            class="btn btn-outline-secondary mb-2 question-nav-btn"
                            data-question-id="{{ eq.question_id }}"
                            id="nav-question-{{ eq.question_id }}">
                            {{ eq.order }}.
                            {% if eq.question.question_type == 'choice' %}
                                选择题
                            {% elif eq.question.question_type == 'fill_blank' %}
                                填空题
                            {% elif eq.question.question_type == 'programming' %}
                                编程题
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>
                    <div class="mt-3">
                        <span class="badge bg-success me-2">已回答</span>
                        <span class="badge bg-secondary">未回答</span>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <form id="submit-exam-form" method="post" action="{{ url_for('exams.submit_exam', exam_id=exam.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger btn-lg w-100">提交考试</button>
                </form>
            </div>
        </div>

        <!-- 右侧题目内容 -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 id="question-title">请从左侧选择题目</h5>
                        <div>
                            <span id="question-type-badge" class="badge bg-primary"></span>
                            <span id="question-score-badge" class="badge bg-info ms-2"></span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 当前题目内容 -->
                    <div id="question-content-container">
                        <p class="text-center text-muted">请从左侧选择一道题目开始答题</p>
                    </div>

                    <!-- 选择题选项 -->
                    <div id="options-container" class="mt-3" style="display: none;">
                        <div id="options-list"></div>
                    </div>

                    <!-- 填空题和编程题回答区域 -->
                    <div id="answer-container" class="mt-3" style="display: none;">
                        <form id="answer-form">
                            <input type="hidden" id="question_id" name="question_id">
                            <input type="hidden" id="score_id" name="score_id" value="{{ score_id }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <div class="form-group">
                                <label for="answer_content">您的答案:</label>
                                <textarea class="form-control" id="answer_content" name="answer_content" rows="8"></textarea>
                            </div>
                            <button type="button" id="save-answer-btn" class="btn btn-primary mt-2">保存答案</button>
                            <span id="save-status" class="ms-2 text-success" style="display: none;">已保存</span>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 答题导航按钮 -->
            <div class="d-flex justify-content-between mt-3">
                <button id="prev-question-btn" class="btn btn-secondary" disabled>上一题</button>
                <button id="next-question-btn" class="btn btn-primary" disabled>下一题</button>
            </div>
        </div>
    </div>
    <div class="fixed-bottom bg-light py-2 border-top" style="box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
        <div class="container d-flex justify-content-between align-items-center">
            <div>
                <span id="save-status-indicator">自动保存: <span class="badge badge-secondary">就绪</span></span>
                <small id="last-save-time" class="text-muted ml-2"></small>
            </div>
            <div>
                <button type="button" id="global-save-button" class="btn btn-outline-primary mr-2">保存所有答案</button>
                <button type="button" id="global-submit-button" class="btn btn-danger">提交考试</button>
            </div>
        </div>
    </div>
</div>

<!-- 传递数据给JS文件的脚本 -->
<script>
// 考试基本信息作为全局变量传递给外部JS文件
const EXAM_ID = {{ exam.id }};
const SCORE_ID = {{ score_id }};
const REMAINING_SECONDS = {{ remaining_seconds }};
const EXAM_QUESTIONS = [
    {% for eq in exam_questions %}
    {
        id: {{ eq.question_id }},
        order: {{ eq.order }},
        type: "{{ eq.question.question_type }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];
const CSRF_TOKEN = "{{ csrf_token() }}";
</script>

<!-- 引入外部JS文件 -->
<script src="{{ url_for('static', filename='js/exam_app.js') }}"></script>
<!-- 引入考试计时器脚本 -->
<script src="{{ url_for('static', filename='js/exam_timer.js') }}"></script>
<script>
// 初始化考试计时器
// 确保计时器正确初始化，使用服务器提供的剩余时间
document.addEventListener('DOMContentLoaded', function() {
    // 初始化计时器
    const examTimer = new ExamTimer({
        remainingSeconds: REMAINING_SECONDS,
        timerElementId: 'remaining-time',
        warningThreshold: 300,  // 5分钟警告
        dangerThreshold: 60,    // 1分钟危险警告
        checkServerTime: true,   // 启用与服务器同步
        serverTimeCheckInterval: 30,  // 每30秒同步一次
        serverTimeUrl: '/exams/student/check_time',
        examId: EXAM_ID,
        autoSubmitUrl: '/exams/student/submit_exam/' + EXAM_ID,
        timeUpCallback: function() {
            // 时间到时自动提交
            console.log('考试时间结束，自动提交...');

                try {
                    // 使用正确的表单 ID 'submit-exam-form'
                    const examForm = document.getElementById('submit-exam-form');
                    if (examForm) {
                        examForm.submit();
                    } else {
                        throw new Error('找不到考试表单（#submit-exam-form）');
                    }
                } catch (error) {
                    console.error('自动提交失败:', error);
                    // 添加应急提交方案
                    addEmergencySubmitButton(EXAM_ID);
                }
        }
    });

    // 开始计时
    examTimer.start();

    // 定期记录时间，便于调试
    setInterval(function() {
        console.log('当前剩余时间: ' + examTimer.getRemainingSeconds() + ' 秒');
    }, 60000);  // 每分钟记录一次
});

// 添加应急提交按钮函数
function addEmergencySubmitButton(examId) {
    const container = document.createElement('div');
    container.className = 'alert alert-danger fixed-bottom mb-0 text-center py-3';
    container.innerHTML = `
        <strong>考试时间已结束!</strong>
        <p>系统自动提交失败，请点击下方按钮手动提交考试</p>
        <form method="POST" action="/exams/student/submit_exam/${examId}">
            <input type="hidden" name="csrf_token" value="${document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''}">
            <button type="submit" class="btn btn-danger btn-lg">提交考试</button>
        </form>
    `;
    document.body.appendChild(container);
}
</script>
<script>
    // 等待页面完全加载
    window.addEventListener('load', function() {
        // 确保原始 JavaScript 已经完成加载和初始化
        setTimeout(function() {
            try {
                // 创建计时器实例
                const examTimer = new ExamTimer({
                    // 只使用最基本的选项
                    remainingSeconds: REMAINING_SECONDS
                });

                // 启动计时器
                examTimer.start();
                console.log('计时器初始化成功');
            } catch (error) {
                console.error('计时器初始化失败:', error);
            }
        }, 500); // 延迟 500 毫秒初始化
    });
</script>
<script src="{{ url_for('static', filename='js/exam_leaving_warning.js') }}"></script>
<script>
    // 提交确认流程
    document.addEventListener('DOMContentLoaded', function() {
        // 全局提交按钮
        const globalSubmitBtn = document.getElementById('global-submit-button');
        if (globalSubmitBtn) {
            globalSubmitBtn.addEventListener('click', confirmSubmit);
        }

        // 原有提交按钮
        const originalSubmitForm = document.getElementById('submit-exam-form');
        if (originalSubmitForm) {
            originalSubmitForm.addEventListener('submit', function(e) {
                e.preventDefault();
                confirmSubmit();
            });
        }

        // 确认提交函数
        function confirmSubmit() {
            // 尝试保存所有答案
            if (window.saveAllAnswers) {
                try {
                    window.saveAllAnswers();
                } catch (e) {
                    console.error('保存答案失败:', e);
                }
            }

            // 显示确认对话框
            const confirmed = confirm('提交后在考试时间结束前将不可修改答案！\n\n请仔细检查您的所有答案。\n\n确定要提交考试吗？');

            if (confirmed) {
                // 表单提交
                document.getElementById('submit-exam-form').submit();
            }
        }
    });
</script>
{% endblock %}